#***************************************************************
# WRF Forecast Control File 
# 
# This is the top level configuration file for running 
# automated WRF forecasts. This will overide some settings in 
# 'namelist.wps' and 'namelist.input' files
#
# Environment variables can now be accessed using ${var} syntax
# Variables defined in this file can be accessed using %(syntax)
# If the variable in {} or () is not defined, it will not be expanded
#***************************************************************

#************************************************
# Metadata
#************************************************
&metadata
domain            = baseline_europe 
model             = WRF
model_run         = development
bdy_conditions    = GFS


#************************************************
# Directories/processors. 
#************************************************
&directories
base_dir          = ${HOME}/forecasting/domains
domain_dir        = %(base_dir)/%(domain) 
model_run_dir     = %(domain_dir)/%(model_run)
namelist_wps      = %(model_run_dir)/namelist.wps
namelist_input    = %(model_run_dir)/namelist.input
wps_run_dir       = %(model_run_dir)/wps
wrf_run_dir       = %(model_run_dir)/run
wrfout_dir        = %(model_run_dir)/wrfout 
tseries_dir       = %(model_run_dir)/tseries
host_file         = ${HOME}/wrfmachines   # not uses if queue is False
log_file          = %(model_run_dir)/forecast.log
backup_dir        = /longbackup/slha/forecasting/domains
wrf_dir           = ${HOME}/WRFV3_devel
wps_dir           = ${HOME}/WPS
grb_dir           = ${HOME}/forecasting/domains/GFS/operational
tmp_dir           = ${HOME}/forecasting/tmp
upp_dir           = ${HOME}/UPPV1.0
web_dir           = ${HOME}/web/html/NSeaWRF/%iHZ                                        # plots will be moved here after all plots done
met_em_dir        = %(domain_dir)/met_em/%iY-%im-%id_%iH
locations_file    = ${HOME}/forecasting/locations/locations_devel.csv
pcurve_dir        = ${HOME}/forecasting/pcurves/fuga
wrftools_dir      = ${HOME}/code/wrftools/devel


#************************************************
# Logging
#************************************************
&logging
debug_level       = DEBUG
full_trace        = .True.         # whether to print a stack trace of exceptions
mail_level        = INFO 
#mailto            = sam.hawkins@vattenfall.com
mail_buffer       = 1000            # how many messages to collate in one email
mail_subject      = "Operational WRF log"

#***********************************************
# Forecast settings 
# Date syntax
# i: initial time
# v: valid time
# f: forecast 
# y,m,d,H,M,S: two-digit year, month,day,Hour,Minute,Second
# Y : four-digit year
#***********************************************
&forecast
max_dom            = 1
start              = 2013-06-14 00:00:00,
end                = 2013-06-15 00:00:00,
fcst_hours        = 6
history_interval  = 60
init_interval     = 12
bdy_interval      = 3
#cycles            = 00, 12,

&ungrib

vtable             ={'PLEVS' : 'plevs.gdas',\
                     'SUR': 'surface'}
                     
#vtable            = {'PLEVS': 'Vtable.CFSR_press_pgbh06',\
#                     'SFC': 'Vtable.CFSR_sfc_flxf06',\
#                     'SST': 'Vtable.CFSR_sfc_flxf06'}
                     
grb_input_fmt     = {'PLEVS': '%(grb_dir)/%vY%vm%vd%vH%vM.pgbh06.gdas.pressure.grb2',\ 
                     'SFC': '%(grb_dir)/%vY%vm%vd%vH%vM.flxf06.gdas.surface.grb2',\
                     'SST': '%(grb_dir)/%vY%vm%vd%vH%vM.flxf06.gdas.sst.grb2'}

#vtable            = Vtable.GFS

&metgrid
constants_name    = SST:%iYimid 

#************************************************
# Components to run
#************************************************
&control
fail_mode         = CONTINUE     # CONTINUE, EXIT
run_level         = RUN          # RUN, DUMMY
cmd_timing        = .False.
queue             = .False.      # Use scheduler (e.g. SGE) to run jobs
operational       = .False.      # If True, start time is based on system time
prepare           = .True.
gribmaster        = .True.
sst               = .True.       # Source SST field from seperate source
wps               = .True.
ungrib            = .True.
geogrid           = .True.
metgrid           = .True.
wrf               = .True.
upp               = .False.      # run universal post processor 
timing            = .True.
power             = .False.    # Calculate power production at points
met               = .False.    # Run MET verification tool
ncl               = .True.     # Run ncl visualisations
time_series       = .True.     # Extract time series of variables to points
json              = .True.     # convert time series data to JSON
scripts           = .False.    # run additional scripts
web               = .True.     # copy plots to web out dir
archive           = .False.    # Use rysnc to copy to backup dir
cleanup           = .True.     # Run cleanup script to delete various leftovers

#************************************************
# Queue settings
#***********************************************
num_procs     = {'ungrib.exe': 4, 'geogrid.exe': 4, 'metgrid.exe':8, 'real.exe': 4, 'wrf.exe': 24, 'ncl':1}
job_template  = %(wrftools_dir)/queue/template.sge     # template to expand for SGE/PBS
job_script    = %(wrf_run_dir)/job.sge                 # expanded template gets written here
#queue_name    = all.q                                 # queue to use
queue_name    = {'ungrib.exe'  : 'all.q',\
                 'geogrid.exe' : 'all.q',\
                 'metgrid.exe' : 'all.q',\
                 'real.exe'    : 'all.q',\
                 'wrf.exe'     : 'all.q',\
                 'ncl'         : 'post.q'}             # queue to use


poll_interval = {'ungrib.exe'  : 2,\
                 'geogrid.exe' : 1,\
                 'metgrid.exe' : 2,\
                 'real.exe'    : 1,\
                 'wrf.exe'     : 10,\
                 'ncl'         : 1}                    # minutes between checking queue status


max_job_time  = {'ungrib.exe'  : 10,\
                 'geogrid.exe' : 10,\
                 'metgrid.exe' : 10,\
                 'real.exe'    : 5,\
                 'wrf.exe'     : 60,\
                 'ncl'         : 5}                     # maximum number of minutes to keep polling queue


#************************************************
# Gribmaster settings
# Note that most gribmaster settings are defined in the gribmaster/conf directory
# these are just the command line options
#************************************************
&gribmaster
gm_dir            = /home/slha/gribmaster
gm_log            = %(run_dir)/gribmaster.log
gm_dataset        = gfs004grb2
gm_transfer       = http
grb_fmt           = grib2
gm_delay          = 4 
gm_sleep          = 10         # number of minutes to wait after failure

#*****************************************************
# SST settings
#*****************************************************
&sst
sst_delay           = 24                    # number of hours SST field is delayed
sst_server          = polar.ncep.noaa.gov
sst_server_dir      = /pub/history/sst/ophi
sst_local_dir       = /home/slha/forecasting/domains/SST
sst_filename        = rtg_sst_grb_hr_0.083.%iY%im%id
sst_vtable          = Vtable.SST


#*******************************************************
# Visualisation settings
# Python will set the following environment
# variables which can be used within NCL
# FCST_FILE       - the full WRF filename 
# NCL_OUT_DIR     - output directory for plots
# LOCATIONS_FILE  - file containing locations of interest
# NEST_ID         - 2-digit integer indentifiying nest
#********************************************************
&visualisation
ncl_out_type   = png                                                                        # png, pdf etc
ncl_code_dir   = %(wrftools_dir)/ncl 
ncl_out_dir    = %(model_run_dir)/plots/%HZ        # inital time will be substitued in
ncl_code       = wrf_surface.ncl, wrf_radar.ncl, wrf_time_series.ncl, wrf_precip.ncl, wrf_t2.ncl,
ncl_code       = wrf_time_series.ncl, 
ncl_log        = %(model_run_dir)/ncl.log

#**************************************************************
# Scripts
# Run additional post-processing scripts.
# Check the code wrftools.run_scripts to see/change what 
# environment variables are available to the scripts
# currently this calls one per nest, but this is easily changed
#***************************************************************
&scripts
run_scripts    = /home/jepn/MakePlots4.csh,/home/jepn/MakePlots5.csh
tseries_code   = %(wrftools_dir)/ncl/extract_time_series.ncl, 


#********************************************************
# Archive / backup settings
# The following directories within the domain/model_run
# directory will be moved/copied to the backup directory
#********************************************************
&archive
archive_mode      = MOVE        # COPY or MOVE
backup_dirs       = wrfpost,wrfout,rsl,namelist,tseries  # which subdirs to archive


#**************************************************************
# Prepare. 
# All files matchig  patterns in pre-clean will be removed
# Subdirectories create_dirs within %(model_run_dir) will 
# be created
# All files matching patterns in wrf_links will be linked 
# from %(wrf_dir)/run to %(wrf_run_dir)
# link from and link to should be same length
#**************************************************************
pre_clean       = %(ncl_log),%(gm_log),
create_dirs     = geo_em,met_em,tseries,plots,rsl,postprd,run,wps,namelist, 
link            = %(wrf_dir)/run/*.exe           --> %(wrf_run_dir),\
                  %(wrf_dir)/run/RRTM*           --> %(wrf_run_dir),\
                  %(wrf_dir)/run/*.TBL           --> %(wrf_run_dir),\
                  %(wps_dir)/*.exe               --> %(wps_run_dir),\
                  %(wps_dir)/link_grib.csh       --> %(wps_run_dir),\
                  %(wps_dir)/metgrid/METGRID.TBL --> %(wps_run_dir),\
                  %(wps_dir)/geogrid/GEOGRID.TBL --> %(wps_run_dir)

#************************************************
# Cleanup settings. The following file patterns
# will get removed using rm -f if the cleanup flag is True
# BE VERY CAREFUL SPECIFYING!
# You could easily wipe a directory
#************************************************
&cleanup
post_clean     = %(wps_run_dir)/FILE*, %(wps_run_dir)/GFS*, %(wps_run_dir)/PFILE*, \
                  %(wps_run_dir)/geogrid.log*, %(wps_run_dir)/metgrid.log*,\
                  %(wrf_run_dir)/rsl.error.*, %(wrf_run_dir)/rsl.out.*, %(wrf_run_dir)/met_em*,

#************************************************
# Gribmaster settings
# Note that most gribmaster settings are defined in the gribmaster/conf directory
# these are just the command line options
#************************************************
&gribmaster
gm_dir            = ${HOME}/gribmaster
gm_log            = %(model_run_dir)/gribmaster.log
gm_dataset        = gfs004grb2
gm_transfer       = http
grb_fmt           = grib2
gm_delay          = 4 
gm_sleep          = 0.1         # number of minutes to wait after failure
gm_max_attempts   = 3           # number of times to try before giving up
convert_grb       = .False.     # convert grib1 --> grib2


#*****************************************************
# DFI settings - Not used unless dfi is specified in namelist
# Currently these are in minutes.  
# Usually recommended to integrate backwards one hour and
# forwards for half the time. 
#*****************************************************
&dfi
dfi_bck           = 60
dfi_fwd           = 2160


#*****************************************************
# Verification
#*****************************************************
&verification
met_dir           = /home/slha/METv3.0.1
obs_file          = /home/slha/domains/obs/adpupa.nc


